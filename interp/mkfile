TOP=..
INTERP=evaluating

<../config/noweb.mk

all:V: doc coders

doc:V: design.ps state.ps

coders:V: encode.h encode.c decode.c

design.tex: design.inc
	echo "\input{design.inc}" > $target

state.tex: state.inc
    echo "\input{state.inc}" > $target

clean:V: clean-tex
	rm -f design.tex state.tex bytecode.tex *~

clean-tex:V:
	rm -f *.blg *.log *.dvi *.inc *.toc *.aux

intervals.c:D: intervals.nw
        $NOTANGLE -L -R$target $prereq > $target

intervals.h:D: intervals.nw
	$NOTANGLE -L -R$target $prereq > $target

bytecode.sled:D: bytecode.nw
	$NOTANGLE -L -R$target $prereq > $target

decode.fetch:D: bytecode.nw
	$NOTANGLE -L -R$target $prereq > $target

decode.m:D: bytecode.nw
	$NOTANGLE -L -R$target $prereq > $target

interp.h:D: bytecode.nw
        $NOTANGLE -L -R$target $prereq > $target

encode.c encode.h: bytecode.sled
	tools -lc-cons-names -encoder encode $prereq

encode_tolua.c: encode.h
        echo "#include <mclib.h>" > encode_tolua.c
	/home/lair/olinsky/bin/tolua encode.h >> encode_tolua.c

encode.o: encode.c encode.h
	gcc -c -I/home/lair/olinsky/include/ -o encode.o encode.c

encode_tolua.o: encode_tolua.c
	gcc -c -I/home/lair/olinsky/include/ -o encode_tolua.o encode_tolua.c

mclib.o: 
        gcc -c -I/home/lair/olinsky/include/ -o mclib.o mclib.c

%.c:D: %.m bytecode.sled decode.fetch
	tools -lc-cons-names -decoder $target -matcher $stem.m \
		bytecode.sled decode.fetch

intervals.o: intervals.c intervals.h
        gcc -c -o intervals.o intervals.c

decode.i: decode.c interp.h
        rm -f decode.i ; gcc -I/home/lair/olinsky/include/ -E -P decode.c > decode.i

interp.o: decode.i intervals.h encode.h
        gcc -c -o interp.o decode.i

interp: interp.o intervals.o encode.o mclib.o encode_tolua.o
        gcc -lm -L/home/lair/olinsky/lib/ -o interp interp.o intervals.o encode.o encode_tolua.o mclib.o /home/lair/olinsky/lib/liblua.a /home/lair/olinsky/lib/liblualib.a /home/lair/olinsky/lib/libtolua.a
