BINDIR=/home/lair/olinsky/bin
LIBDIR=/home/lair/olinsky/lib
INCLUDEDIR=include/

CC=gcc
CFLAGS=-g
LIBS=-lm

TOOLS=$BINDIR/tools
DEPEND=$CC -MM -I$INCLUDEDIR -I.

HDRS=encode.h interp.h machine.h intervals.h runtime.h client.h clients/gc.h
SRCS=assert.c atom.c bcdis-dec.c encode.c except.c interp-dec.c intervals.c \
     mclib.c mem.c runtime.c client.c clients/gc.c
OBJS=assert.o atom.o bcdis-dec.o encode.o except.o interp-dec.o intervals.o \
     mclib.o mem.o runtime.o

TOP=..
INTERP=evaluating

<../config/noweb.mk

all:V: interp

gc:V:  clients/gc_client

doc:V: design.ps state.ps

design.tex: design.inc
	echo "\input{design.inc}" > $target

state.tex: state.inc
    echo "\input{state.inc}" > $target

interp.tex: interp.nw
	$NOWEAVE -delay -autodefs c -index $prereq > $target

depend:V: $SRCS $HDRS
    cp mkfile mkfile.bak
    sed '/^# DO NOT DELETE/q' mkfile.bak > mkfile
    $DEPEND $SRCS | sed 's/gc\.o:/clients\/gc\.o:/' >> mkfile

clean:V: clean-tex clean-code clean-obj
	rm -f design.tex state.tex bytecode.tex interp.tex intervals.tex opgen.tex client.tex clients/gc.tex runtime.tex interp clients/gc_client *~

clean-tex:V:
	rm -f *.blg *.log *.dvi *.inc *.toc *.aux clients/*.blg clients/*.inc

clean-code:V:
    rm -f *.m *.h clients/*.h *.i *-dec.c intervals.c encode.c runtime.c client.c decode.fetch bytecode.sled clients/gc.c clients/*.i

clean-obj:V:
    rm -f *.o clients/*.o

#
# source code targets
#
intervals.c: intervals.nw
    $NOTANGLE -L -R$target $prereq > $target

bytecode.sled:D: interp.nw
	$NOTANGLE -L -R$target $prereq > $target

decode.fetch:D: interp.nw
    $NOTANGLE -L -R$target $prereq > $target

machine.h:D: interp.nw
    $NOTANGLE -L -R$target $prereq > $target

encode.c encode.h: bytecode.sled
    $TOOLS -lc-cons-names -encoder encode $prereq

runtime.c: runtime.nw
    $NOTANGLE -R$target $prereq > $target

%-dec.c:D: %.m bytecode.sled decode.fetch
    $TOOLS -lc-cons-names -decoder $target -matcher $stem.m \
		bytecode.sled decode.fetch

'(([^/]*/)*)(.*)\.h$':RD:       '\1\3.nw'
	$NOTANGLE -L -R$stem3.h $prereq > $target

%.m:D: interp.nw
    $NOTANGLE -R$target $prereq > $target

#
# intermediate code targets
#
'(([^/]*/)*)(.*)\.i$':RD:       '\1\3.c'
    $CC -P -E -I$INCLUDEDIR -I. $prereq > $target

#
# object code targets
#
%.o: %.c
    $CC $CFLAGS -c -I$INCLUDEDIR -I. -o $target $stem.c

#
# operator generator targets (not currently used)
#
opgen:	opgen.icn
	icont -o $target $prereq

%.icn:D: %.nw
	$NOTANGLE -L'#line %-1L "%F"%N' -R$target $prereq > $target

optest:V: opgen
	echo "v1:f32 v2:f32 feq32 -- v1 == v2 : bool" | ./opgen

%-ops.c:D: %.ops opgen
	./opgen $stem.ops > $target

#
# compiled targets
#
interp: $OBJS client.o
    $CC -g $LIBS -L$LIBDIR -o $target $OBJS client.o $LIBDIR/liblua.a $LIBDIR/liblualib.a

clients/gc_client: $OBJS clients/gc.o
    $CC -g $LIBS -L$LIBDIR -o $target $OBJS clients/gc.o $LIBDIR/liblua.a $LIBDIR/liblualib.a

#
# dependencies 
#
# DO NOT DELETE THIS LINE -- mk depend depends on it
assert.o: assert.c
atom.o: atom.c
bcdis-dec.o: bcdis-dec.c interp.h intervals.h encode.h machine.h
encode.o: encode.c encode.h
except.o: except.c
interp-dec.o: interp-dec.c interp.h intervals.h include/mclib.h \
 encode.h machine.h
intervals.o: intervals.c intervals.h
mclib.o: mclib.c
mem.o: mem.c
runtime.o: runtime.c runtime.h interp.h intervals.h include/mclib.h \
 encode.h machine.h
client.o: client.c client.h interp.h intervals.h include/mclib.h \
 encode.h machine.h runtime.h
clients/gc.o: clients/gc.c clients/gc.h runtime.h interp.h intervals.h \
 include/mclib.h encode.h machine.h
