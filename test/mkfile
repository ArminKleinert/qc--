#
# Adding a new test:
# (1) create a test file: foo.c--
# (2) the head of the test file must include a test commands:
#     /// ./regr "../bin/qc-- -c $SELF" $REGRFLAGS -out $BASE.1
# (3) call 'mk foo.record'  to record expected results in foo.1
# (4) check that the results are indeed the expected ones
# (5) add foo.c-- foo.1 (foo.2) to CVS

# ------------------------------------------------------------------ 
# paths
# ------------------------------------------------------------------ 

TOP    =    ..
LIBDIR =    ../lib
BINDIR =    ../bin
MANDIR =    ../man

< $TOP/config/noweb.mk

# ------------------------------------------------------------------  
# high level targets
# ------------------------------------------------------------------  

SRC    = `echo *.c--`
TEST   = ${SRC:%.c--=%.test}
RECORD = ${SRC:%.c--=%.record}
X86SRC = `echo x86*.c--`
X86TEST   = ${X86SRC:%.c--=%.test}
X86RECORD = ${X86SRC:%.c--=%.record}
VERBOSE =

test:VQ:        $TEST
vtest:VQ:	mk $MKFLAGS VERBOSE=-v test
record:VQ:      $RECORD

test-x86:VQ:        $X86TEST
vtest-x86:VQ:	mk $MKFLAGS VERBOSE=-v test-x86
record-x86:VQ:      $X86RECORD

# ------------------------------------------------------------------ 
# useful targets to create test results
# ------------------------------------------------------------------ 

%.test:VQ:       %.c-- ../bin/qc-- fp regr
		SELF=$stem.c--
		BASE=$stem
		MKTARGET=$target
		case $VERBOSE in -v) SHX=-x ;; *) SHX= ;; esac
		export SELF BASE MKTARGET
                sed -n 's!^///!!p' $SELF | sh $SHX || true
		case "$VERBOSE$stem" in -v*) ;; *0) echo "# tested $stem" ;; esac

# The update rule updates the expected output of a test.  Use
# only after you have verified that the factual output is indeed the
# expected output!

%.record:VQ:     %.c-- ../bin/qc-- fp regr       
		SELF=$stem.c--
		BASE=$stem
                REGRFLAGS="-r"
		export SELF BASE REGRFLAGS
                sed -n 's!^///!!p' $SELF | sh -x || true
		# why is there || true on the preceding line??

# ------------------------------------------------------------------  
# sources generated from noweb sources
# ------------------------------------------------------------------  

fp:             test.nw
                $NOTANGLE -R$target $prereq > $target
                chmod +x $target
                
regr:           test.nw
                $NOTANGLE -R$target $prereq > $target
                chmod +x $target

html:V:         test.html
