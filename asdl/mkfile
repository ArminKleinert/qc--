# ------------------------------------------------------------------ 
# $Id$ 
# ------------------------------------------------------------------ 

NAME =      asdl

# ------------------------------------------------------------------ 
# paths
# ------------------------------------------------------------------ 

TOP    =    ..
LIBDIR =    ../lib
BINDIR =    ../bin
MANDIR =    ../man


# ------------------------------------------------------------------ 
# rules and tools for OCaml
# ------------------------------------------------------------------ 

<../config/ocaml.mk

#
# compiler flags used by the rules just included
#

OCAMLC_FLAGS =  -I $LIBDIR
OCAMLO_FLAGS =  -I $LIBDIR

# ------------------------------------------------------------------ 
# (high level) virtual targets
# ------------------------------------------------------------------ 

LIBCMX=$NAME.cmxa
LIBCMO=$NAME.cma

all:V:          $LIBCMO
all.opt:V:      $LIBCMX

update:V:       dirs $LIBDIR/$LIBCMO 
update.opt:V:   dirs $LIBDIR/$LIBCMX

clean:V:    
                rm -f $CMO $CMX $CMI $OBJ
                rm -f *.output
                rm -f $LIBCMX $LIBCMO $NAME.a

depend:V:       DEPEND


dvi\
html:VQ:
                echo "nothing to be done for $target"


dirs:VQ:
                for i in $LIBDIR; do
                    if [ ! -d $i ]; then
                        echo "missing directory $i"
                        echo "invoke mk from the toplevel the first time"
                        echo "to create all directories"
                        false
                    fi
                done    

# ------------------------------------------------------------------ 
# important file sets
# ------------------------------------------------------------------ 

MLI =   share.mli sexpLex.mli sexpPkl.mli pklInt.mli stdPkl.mli\
        stdPrims.mli stdPrimsUtil.mli

ML  =   share.ml  sexpLex.ml  sexpPkl.ml  pklInt.ml  stdPkl.ml \
        stdPrims.ml  stdPrimsUtil.ml  

# list all *.ml *.mli souces generated by some tool below
# we need to generated them before we can generated the list
# of dependencies (see target depend)

SCAN = $MLI $ML


CMO =           `echo $ML       | sed 's/\.ml/.cmo/g'`
CMX =           `echo $ML       | sed 's/\.ml/.cmx/g'`
OBJ =           `echo $ML       | sed 's/\.ml/.o/g;'`
CMI =           `echo $ML $MLI  | sed 's/\.mli*/.cmi/g'`

# ------------------------------------------------------------------ 
# build the libraries
# ------------------------------------------------------------------ 


$LIBCMO:        $CMO
		$OCAMLC $OCAMLC_FLAGS -a -o $target $prereq
                

$LIBCMX:	$CMX
		$OCAMLO $OCAMLO_FLAGS -a -o $target $prereq
                

# ------------------------------------------------------------------ 
# update hierarchy
# ------------------------------------------------------------------ 

$LIBDIR/$LIBCMO:    $LIBCMO
		    for i in $LIBCMO *.mli *.cmi; do		    \
		        cmp -s $i $LIBDIR/$i || cp $i $LIBDIR ;     \
		    done

$LIBDIR/$LIBCMX:    $LIBCMX 
		    for i in $LIBCMX $NAME.a *.mli *.cmi; do	    \
		        cmp -s $i $LIBDIR/$$i || cp $i $LIBDIR ;    \
		    done

# ------------------------------------------------------------------ 
# recalculate dependencies
# make sure that generators are run first
# ------------------------------------------------------------------ 

DEPEND:         $SCAN
		$OCAMLDEP $SCAN > DEPEND

# ------------------------------------------------------------------ 
# include dependencies
# ------------------------------------------------------------------ 

<DEPEND

